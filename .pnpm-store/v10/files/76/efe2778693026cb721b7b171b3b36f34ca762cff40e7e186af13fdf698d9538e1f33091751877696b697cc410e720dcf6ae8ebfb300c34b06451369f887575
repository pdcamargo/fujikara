// src/index.ts
import { createBuilder } from "@content-collections/core";
import { configureLogging } from "@content-collections/integrations";
import path from "node:path";
var defaultOptions = {
  configPath: "content-collections.ts"
};
function resolveConfigPath(root, configPath) {
  if (!path.isAbsolute(configPath)) {
    configPath = path.resolve(root, configPath);
  }
  return configPath;
}
function contentCollectionsPlugin(options = {}) {
  const pluginOptions = { ...defaultOptions, ...options };
  let builder;
  function isEnabled(config) {
    return options.isEnabled ? options.isEnabled(config) : true;
  }
  return {
    name: "content-collections",
    config(config) {
      let configPath = resolveConfigPath(
        config.root || process.cwd(),
        pluginOptions.configPath
      );
      const directory = path.resolve(
        path.dirname(configPath),
        "./.content-collections/generated"
      );
      const configPatch = {
        optimizeDeps: {
          exclude: ["content-collections"]
        },
        resolve: {
          alias: {
            "content-collections": directory
          }
        }
      };
      if ((config.server?.fs?.allow || []).length > 0) {
        configPatch.server = {
          fs: {
            allow: [directory]
          }
        };
      }
      return configPatch;
    },
    async configResolved(config) {
      if (!isEnabled(config)) {
        return;
      }
      let configPath = resolveConfigPath(config.root, pluginOptions.configPath);
      console.log(
        "Starting content-collections with config",
        path.relative(process.cwd(), configPath)
      );
      builder = await createBuilder(configPath);
      configureLogging(builder);
      return;
    },
    async buildStart() {
      if (!builder) {
        return;
      }
      console.log("Start initial build");
      await builder.build();
      return;
    },
    async configureServer() {
      if (!builder) {
        return;
      }
      console.log("Start watching");
      builder.watch();
      return;
    }
  };
}
export {
  contentCollectionsPlugin as default
};
